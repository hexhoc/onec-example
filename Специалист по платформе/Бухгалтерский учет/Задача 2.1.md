
# Описание

Взаиморасчеты с покупателями ведутся в разрезе договоров. С каждым контрагентом может быть заключено произвольное количество договоров. Задолженность покупателей возникает при проведении документа «Расходная накладная». В этом документе пользователь указывает покупателя («Контрагента») и договор (договор вместе с контрагентом указывается в шапке документа). Пользователю должно быть запрещено указывать не соответствующий контрагенту договор. 

```
Документ «Расходная накладная» формирует следующую проводку: 
Дт «Покупатели» Кт «Прибыли и убытки» – на сумму продажи
```

Погашение задолженности (оплата переданного покупателю товара) регистрируется с помощью документа «Приход денег». В табличной части документа указываются контрагент, договор и сумма оплаты. В случае превышения суммы оплаты над суммой задолженности по какому-либо из договоров документ не проводится, но при этом нужно учесть, что задолженность может погашаться частями.

```
Документ «Приход денег» формирует следующую проводку: 
Дт «Касса» Кт «Покупатели» – на указанную сумму
```
 

Необходимо создать отчет по состоянию взаиморасчетов с покупателями на дату. В отчете должна быть видна как общая задолженность по контрагенту, так и эта же задолженность, но в разрезе действующих договоров.


Взаиморасчеты с покупателями за период с 01.01.2022 по 31.01.2022

| Контрагент   | Договор    | Регистратор                                          | Оплата | Отгрузка |
| ------------ | ---------- | ---------------------------------------------------- | ------ | -------- |
| Контрагент 1 |            |                                                      | 500,00 | 2 000,00 |
|              | Договор К1 |                                                      | 500,00 | 2 000,00 |
|              |            | Расходная накладная 000000001 от 13.03.2025 21:13:14 |        | 2 000,00 |
|              |            | Приход денег 000000001 от 15.03.2025 12:00:00        | 500,00 |          |
| Контрагент 2 |            |                                                      |        | 200,00   |
|              | Договор К2 |                                                      |        | 200,00   |
|              |            | Расходная накладная 000000002 от 15.03.2025 12:00:00 |        | 200,00   |


Задолженность покупателей на 01.03.2022

| Контрагент   | Договор    | Сумма    |
| ------------ | ---------- | -------- |
| Контрагент 1 |            | 1 500,00 |
|              | Договор К1 | 1 500,00 |
| Контрагент 2 |            | 200,00   |
|              | Договор К2 | 200,00   |

# Метаданные

## Документы

Расходная накладная

Приход денег
- ТЧ Список Контрагентов
	- Контрагент
	- Договор
	- Сумма

## Справочники

Контрагенты

Договоры
- Владелец: Контрагенты

Субконто
- Владелец: ВидыСубконто

## Планы видов характеристик

СвойстваОбъектов
- Тип значения характеристик: Строка

ВидыСубконто
- Тип значения характеристик: Список необходимых справочников (составной тип) - Контрагенты, Номенклатура
- Дополнительные значения характеристик: Справочник.Субконто
- Предопределенные:
	- Контрагенты
	- Договоры

## Планы счетов

Управленческий
- Длина кода: 5
- Маска кода: @@.@@
- Автопорядок по коду: Истина
- Признаки учета: Суммовой (булево)
- Признаки учета субконто: Суммовой (булево)
- Макс. кол-во субконто: 2
- Предопределенные счета учета:
	- 01 Активы (активный)
		- 01.01 Касса (активный)
	- 03 ПрибылиУбытки (активно/пассивный)
## Регистры бухгалтерии

Управленческий
- План счетов: Управленческий
- Корреспонденция: Истина
- Регистраторы:
	- Приход денег
	- Расходная накладная
- Ресурсы:
	- Сумма
		- Балансовый: Истина
		- Признак учета: Пусто
		- Признак учета субконто: Суммовой


# Реализация


## Приход денег

```onec

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	Движения.Управленческий.Записывать = Истина;
	Движения.Управленческий.Очистить();
	Движения.Управленческий.Записать();
	
	ДвиженияУправленческий();
КонецПроцедуры               

Процедура ДвиженияУправленческий()
	Для каждого Строка Из СписокПлатежей Цикл
		Запись = Движения.Управленческий.Добавить();
		Запись.Период = Дата;
		Запись.СчетДт = ПланыСчетов.Управленческий.Касса;
		Запись.СчетКт = ПланыСчетов.Управленческий.Покупатели;
		Запись.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Контрагенты] = Строка.Контрагент;
		Запись.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Договоры] = Строка.Договор;
		Запись.Сумма = Строка.Сумма;
	КонецЦикла;
КонецПроцедуры
```


## Расходная накладная

```onec
Процедура ДвиженияУправленческий() 
	
	Запись = Движения.Управленческий.Добавить();     
	Запись.Период = Дата;
	Запись.СчетДт = ПланыСчетов.Управленческий.Покупатели;
	Запись.СчетКт = ПланыСчетов.Управленческий.ПрибылиУбытки;
    Запись.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Контрагенты] = Контрагент;
	Запись.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Договоры] = Договор; 
	Запись.Сумма = ТоварыИУслуги.Итог("Сумма");
	
КонецПроцедуры
```

## Взаиморасчеты покупателей

```sql
ВЫБРАТЬ
	УправленческийОбороты.Счет КАК Счет,
	УправленческийОбороты.Субконто1 КАК Контрагент,
	УправленческийОбороты.Субконто2 КАК Договор,          
	УправленческийОбороты.СуммаОборотДт КАК Отгрузка,
	УправленческийОбороты.СуммаОборотКт КАК Оплата,
	УправленческийОбороты.Регистратор КАК Документ
ИЗ
	РегистрБухгалтерии.Управленческий.Обороты(, , Регистратор, Счет = Значение(ПланСчетов.Управленческий.Покупатели), , , , ) КАК УправленческийОбороты
```
## Задолженность покупателей

```sql
ВЫБРАТЬ
	УправленческийОстатки.Субконто1 КАК Контрагент,
	УправленческийОстатки.Субконто2 КАК Договор,
	УправленческийОстатки.СуммаОстаток КАК Сумма
ИЗ
	РегистрБухгалтерии.Управленческий.Остатки(, Счет = Значение(ПланСчетов.Управленческий.Покупатели), , ) КАК УправленческийОстатки
```